<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App | chart</title>
    
</head>

<body>

    <form id="form_user_id" action="#" method="post">


    <label for="user_ID">User IDs</label>
    <select name="user_id" id="userid">
        <option value="">--Select User ID--</option>
        {% for key in user_ids %}
        <option value="{{ key }}" {% if key == selected_user_id %}selected{% endif %}>{{ key }}</option>
        {% endfor %}


    </select>

    <input type="submit" value="Submit" />
    

</form>

<p> default MA window size is 5 </p>



<button id="lastHourButton" type="submit">Last hour</button>
<button id="lastDayButton" type="submit">Last day</button>
<button id="lastMonthButton" type="submit">Last month</button>
    
    <div id="tester" style="height: 900px"></div>
    <script>

    window.onload = function() {
        

            function updateChart(timestamps, heart_rates,heart_rates_MA) {
                // console.log('updateChart called with', timestamps, heart_rates);
                var heartRateData = {
                    x: timestamps,
                    y: heart_rates.map(Number),
                    type: 'scatter',
                    name: 'Heart Rate',
                    line: { color: 'blue' },
                };
                 var heartRateData_MA ={
                    x: timestamps,
                    y: heart_rates_MA.map(Number),
                    type:'scatter',
                    name:'heart_rates_MA',
                    smoothing: 1,
                    line:{color: 'red'},

                 };
    
                var data = [heartRateData, heartRateData_MA];
                var layout = {
                    title: 'Heart Rate Over Time with Moving Average',
                    xaxis: {
                        title: 'Time',
                        showgrid: false,
                        zeroline: false,
                        type: 'date',
                    },
                    yaxis: {
                        title: 'Heart Rate',
                        showline: false,
                    },
                };
    
                var testplot = document.getElementById('tester');
                Plotly.react(testplot, data, layout);
            }
    
            function fetchDataForInterval(interval) {
                var userId = document.getElementById("userid").value;
                if (!userId) {
                    alert("Please select a User ID first.");
                    return;
    }
                fetch(`/time_interval?interval=${interval}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server responded with status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received data:', data);
                        var heart_ratees = (data.heart_rates).map(Number)
                        var heart_ratees_MA = (data.heart_rates_MA).map(Number)
                        updateChart(data.timestamps, heart_ratees,heart_ratees_MA);
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }

        //     function handleFormSubmit(event) {
        //     event.preventDefault();
        //     fetchDataForInterval('hour'); 
        // }
    

    
            document.getElementById("lastHourButton").addEventListener("click", function() {
                fetchDataForInterval('hour');
            });
    
            document.getElementById("lastDayButton").addEventListener("click", function() {
                fetchDataForInterval('day');
            });
    
            document.getElementById("lastMonthButton").addEventListener("click", function() {
                fetchDataForInterval('month');
            });
            

        

        };
    </script>
       
    <script src="/static/js/plotly-2.25.2.min.js"></script>

</body>

</html>